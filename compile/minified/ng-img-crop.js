/*! ngImgCrop v0.2.0 License: MIT */!function(){"use strict";var e=angular.module("ngImgCrop",[]);e.factory("cropAreaCircle",["cropArea",function(e){var t=function(){e.apply(this,arguments),this._boxResizeBaseSize=20,this._boxResizeNormalRatio=.9,this._boxResizeHoverRatio=1.2,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio,this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize={w:0,h:0},this._boxResizeIsHover=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!1,this._areaIsDragging=!1};return t.prototype=new e,t.prototype.getType=function(){return"circle"},t.prototype._calcCirclePerimeterCoords=function(e){var t=this.getCenterPoint(),i=this.getSize(),r=e*(Math.PI/180),s=t.x+i.w/2*Math.cos(r),a=t.y+i.h/2*Math.sin(r);return[s,a]},t.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)},t.prototype._isCoordWithinArea=function(e){var t=this.getCenterPoint();return Math.sqrt((e[0]-t.x)*(e[0]-t.x)+(e[1]-t.y)*(e[1]-t.y))<this._size.h/2},t.prototype._isCoordWithinBoxResize=function(e){var t=this._calcResizeIconCenterCoords(),i=this._boxResizeHoverSize/2;return e[0]>t[0]-i&&e[0]<t[0]+i&&e[1]>t[1]-i&&e[1]<t[1]+i},t.prototype._drawArea=function(e,t,i){e.arc(t.x,t.y,i.h/2,0,2*Math.PI)},t.prototype.draw=function(){e.prototype.draw.apply(this,arguments);var t=this.getCenterPoint();this._cropCanvas.drawIconMove([t.x,t.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio),this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)},t.prototype.processMouseMove=function(e,t){var i="default",r=!1;if(this._boxResizeIsHover=!1,this._areaIsHover=!1,this._areaIsDragging)this.setCenterPoint({x:e-this._posDragStartX,y:t-this._posDragStartY}),this._areaIsHover=!0,i="move",r=!0,this._events.trigger("area-move");else if(this._boxResizeIsDragging){i="nesw-resize";var s,a,o;a=e-this._posResizeStartX,o=this._posResizeStartY-t,s=a>o?this._posResizeStartSize.h+2*o:this._posResizeStartSize.w+2*a;var n=this.getCenterPoint();this.setSize(Math.max(this._minSize.h,s)),this.setCenterPoint(n),this._boxResizeIsHover=!0,r=!0,this._events.trigger("area-resize")}else this._isCoordWithinBoxResize([e,t])?(i="nesw-resize",this._areaIsHover=!1,this._boxResizeIsHover=!0,r=!0):this._isCoordWithinArea([e,t])&&(i="move",this._areaIsHover=!0,r=!0);return angular.element(this._ctx.canvas).css({cursor:i}),r},t.prototype.processMouseDown=function(e,t){this._isCoordWithinBoxResize([e,t])?(this._areaIsDragging=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!0,this._boxResizeIsHover=!0,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._boxResizeIsDragging=!1,this._boxResizeIsHover=!1,this._posDragStartX=e-this.getCenterPoint().x,this._posDragStartY=t-this.getCenterPoint().y,this._events.trigger("area-move-start"))},t.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},t}]),e.factory("cropAreaRectangle",["cropArea",function(e){var t=function(){e.apply(this,arguments),this._resizeCtrlBaseRadius=10,this._resizeCtrlNormalRatio=.75,this._resizeCtrlHoverRatio=1,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio,this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize={w:0,h:0},this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._resizeCtrlIsDragging=-1,this._areaIsDragging=!1};return t.prototype=new e,t.prototype.getType=function(){return"rectangle"},t.prototype._calcRectangleCorners=function(){var e=this.getSize(),t=this.getSouthEastBound();return[[e.x,e.y],[t.x,e.y],[e.x,t.y],[t.x,t.y]]},t.prototype._calcRectangleDimensions=function(){var e=this.getSize(),t=this.getSouthEastBound();return{left:e.x,top:e.y,right:t.x,bottom:t.y}},t.prototype._isCoordWithinArea=function(e){var t=this._calcRectangleDimensions();return e[0]>=t.left&&e[0]<=t.right&&e[1]>=t.top&&e[1]<=t.bottom},t.prototype._isCoordWithinResizeCtrl=function(e){for(var t=this._calcRectangleCorners(),i=-1,r=0,s=t.length;s>r;r++){var a=t[r];if(e[0]>a[0]-this._resizeCtrlHoverRadius&&e[0]<a[0]+this._resizeCtrlHoverRadius&&e[1]>a[1]-this._resizeCtrlHoverRadius&&e[1]<a[1]+this._resizeCtrlHoverRadius){i=r;break}}return i},t.prototype._drawArea=function(e,t,i){e.rect(i.x,i.y,i.w,i.h)},t.prototype.draw=function(){e.prototype.draw.apply(this,arguments);var t=this.getCenterPoint();this._cropCanvas.drawIconMove([t.x,t.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var i=this._calcRectangleCorners(),r=0,s=i.length;s>r;r++){var a=i[r];this._cropCanvas.drawIconResizeCircle(a,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===r?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},t.prototype.processMouseMove=function(e,t){var i="default",r=!1;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this.setCenterPoint({x:e-this._posDragStartX,y:t-this._posDragStartY}),this._areaIsHover=!0,i="move",r=!0,this._events.trigger("area-move");else if(this._resizeCtrlIsDragging>-1){var s=this.getSize(),a=this.getSouthEastBound();switch(this._resizeCtrlIsDragging){case 0:this.setSizeByCorners({x:e,y:t},{x:a.x,y:a.y}),i="nwse-resize";break;case 1:this.setSizeByCorners({x:s.x,y:t},{x:e,y:a.y}),i="nesw-resize";break;case 2:this.setSizeByCorners({x:e,y:s.y},{x:a.x,y:t}),i="nesw-resize";break;case 3:this.setSizeByCorners({x:s.x,y:s.y},{x:e,y:t}),i="nwse-resize"}this._resizeCtrlIsHover=this._resizeCtrlIsDragging,r=!0,this._events.trigger("area-resize")}else{var o=this._isCoordWithinResizeCtrl([e,t]);if(o>-1){switch(o){case 0:i="nwse-resize";break;case 1:i="nesw-resize";break;case 2:i="nesw-resize";break;case 3:i="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=o,r=!0}else this._isCoordWithinArea([e,t])&&(i="move",this._areaIsHover=!0,r=!0)}return angular.element(this._ctx.canvas).css({cursor:i}),r},t.prototype.processMouseDown=function(e,t){var i=this._isCoordWithinResizeCtrl([e,t]);if(i>-1)this._areaIsDragging=!1,this._areaIsHover=!1,this._resizeCtrlIsDragging=i,this._resizeCtrlIsHover=i,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start");else if(this._isCoordWithinArea([e,t])){this._areaIsDragging=!0,this._areaIsHover=!0,this._resizeCtrlIsDragging=-1,this._resizeCtrlIsHover=-1;var r=this.getCenterPoint();this._posDragStartX=e-r.x,this._posDragStartY=t-r.y,this._events.trigger("area-move-start")}},t.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._resizeCtrlIsDragging>-1&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},t}]),e.factory("cropAreaSquare",["cropArea","cropAreaRectangle",function(e,t){var i=function(){t.apply(this,arguments)};return i.prototype=new t,i.prototype.getType=function(){return"square"},i.prototype.processMouseMove=function(e,t){var i="default",r=!1;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this.setCenterPoint({x:e-this._posDragStartX,y:t-this._posDragStartY}),this._areaIsHover=!0,i="move",r=!0,this._events.trigger("area-move");else if(this._resizeCtrlIsDragging>-1){var s,a;switch(this._resizeCtrlIsDragging){case 0:s=-1,a=-1,i="nwse-resize";break;case 1:s=1,a=-1,i="nesw-resize";break;case 2:s=-1,a=1,i="nesw-resize";break;case 3:s=1,a=1,i="nwse-resize"}var o,n=(e-this._posResizeStartX)*s,h=(t-this._posResizeStartY)*a;o=n>h?this._posResizeStartSize.w+h:this._posResizeStartSize.h+n;var c=this.getCenterPoint();this.setSize(Math.max(this._minSize.w,o)),this.setCenterPoint(c),this._resizeCtrlIsHover=this._resizeCtrlIsDragging,r=!0,this._events.trigger("area-resize")}else{var g=this._isCoordWithinResizeCtrl([e,t]);if(g>-1){switch(g){case 0:i="nwse-resize";break;case 1:i="nesw-resize";break;case 2:i="nesw-resize";break;case 3:i="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=g,r=!0}else this._isCoordWithinArea([e,t])&&(i="move",this._areaIsHover=!0,r=!0)}return angular.element(this._ctx.canvas).css({cursor:i}),r},i}]),e.factory("cropArea",["cropCanvas",function(e){var t=function(t,i){this._ctx=t,this._events=i,this._aspectRatio=null,this._minSize={x:0,y:0,w:80,h:80},this._cropCanvas=new e(t),this._image=new Image,this._size={x:0,y:0,w:200,h:200}};return t.prototype.getImage=function(){return this._image},t.prototype.setImage=function(e){this._image=e},t.prototype.getSize=function(){return this._size},t.prototype.setSize=function(e){e=this._processSize(e),this._size=this._preventBoundaryCollision(e)},t.prototype.setSizeByCorners=function(e,t){var i={x:e.x,y:e.y,w:t.x-e.x,h:t.y-e.y};this.setSize(i)},t.prototype.getSouthEastBound=function(){return this._southEastBound(this.getSize())},t.prototype.getMinSize=function(){return this._minSize},t.prototype.getCenterPoint=function(){var e=this.getSize();return{x:e.x+e.w/2,y:e.y+e.h/2}},t.prototype.setCenterPoint=function(e){var t=this.getSize();this.setSize({x:e.x-t.w/2,y:e.y-t.h/2,w:t.w,h:t.h})},t.prototype.setAspectRatio=function(e){this._aspectRatio=e,this._minSize=this._processSize(this._minSize),this.setSize(this._minSize)},t.prototype.setMinSize=function(e){this._minSize=this._processSize(e),this.setSize(this._minSize)},t.prototype.getType=function(){return"circle"},t.prototype._preventBoundaryCollision=function(e){var t=this._ctx.canvas.height,i=this._ctx.canvas.width,r={x:e.x,y:e.y},s=this._southEastBound(e);r.x<0&&(r.x=0),r.y<0&&(r.y=0),s.x>i&&(s.x=i),s.y>t&&(s.y=t);var a={x:r.x,y:r.y,w:s.x-r.x,h:s.y-r.y};a.w<this._minSize.w&&(a.w=this._minSize.w,s=this._southEastBound(a),s.x>i&&(s.x=i,r.x=Math.max(s.x-i,s.x-this._minSize.w),a={x:r.x,y:r.y,w:s.x-r.x,h:s.y-r.y})),a.h<this._minSize.h&&(a.h=this._minSize.h,s=this._southEastBound(a),s.y>t&&(s.y=t,r.y=Math.max(s.y-t,s.y-this._minSize.h),a={x:r.x,y:r.y,w:s.x-r.x,h:s.y-r.y}));var o=this.getType();if("circle"===o||"square"===o)a={x:a.x,y:a.y,w:Math.min(a.w,a.h),h:Math.min(a.w,a.h)};else if("rectangle"===o&&null!==this._aspectRatio){var t=this._ctx.canvas.height,n=a.w/this._aspectRatio;t>n&&s.y<t?a.h=a.w/this._aspectRatio:a.w=a.h*this._aspectRatio}return a},t.prototype._drawArea=function(){},t.prototype._processSize=function(e){return"number"==typeof e&&(e={w:e,h:e}),{x:e.x||this._minSize.x,y:e.y||this._minSize.y,w:e.w||this._minSize.w,h:e.h||this._minSize.h}},t.prototype._southEastBound=function(e){return{x:e.x+e.w,y:e.y+e.h}},t.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,this.getCenterPoint(),this._size,this._drawArea)},t.prototype.processMouseMove=function(){},t.prototype.processMouseDown=function(){},t.prototype.processMouseUp=function(){},t}]),e.factory("cropCanvas",[function(){var e=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],t=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],i=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],r=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],s=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],a=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],o=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],n=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],h={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"};return function(c){var g=function(e,t,i){return[i*e[0]+t[0],i*e[1]+t[1]]},u=function(e){var t=e.naturalWidth,i=e.naturalHeight;if(t*i>1048576){var r=document.createElement("canvas");r.width=r.height=1;var s=r.getContext("2d");return s.drawImage(e,-t+1,0),0===s.getImageData(0,0,1,1).data[3]}return!1},l=function(e,t,i){var r=document.createElement("canvas");r.width=1,r.height=i;var s=r.getContext("2d");s.drawImage(e,0,0);for(var a=s.getImageData(0,0,1,i).data,o=0,n=i,h=i;h>o;){var c=a[4*(h-1)+3];0===c?n=h:o=h,h=n+o>>1}var g=h/i;return 0===g?1:g},p=function(e,t,i,r){c.save(),c.fillStyle=t,c.beginPath();var s,a=g(e[0],i,r);c.moveTo(a[0],a[1]);for(var o in e)o>0&&(s=g(e[o],i,r),c.lineTo(s[0],s[1]));c.lineTo(a[0],a[1]),c.fill(),c.closePath(),c.restore()};this.drawIconMove=function(e,t){p(s,h.moveIconFill,e,t),p(a,h.moveIconFill,e,t),p(o,h.moveIconFill,e,t),p(n,h.moveIconFill,e,t)},this.drawIconResizeCircle=function(e,t,i){var r=t*i;c.save(),c.strokeStyle=h.resizeCircleStroke,c.lineWidth=2,c.fillStyle=h.resizeCircleFill,c.beginPath(),c.arc(e[0],e[1],r,0,2*Math.PI),c.fill(),c.stroke(),c.closePath(),c.restore()},this.drawIconResizeBoxBase=function(e,t,i){var r=t*i;c.save(),c.strokeStyle=h.resizeBoxStroke,c.lineWidth=2,c.fillStyle=h.resizeBoxFill,c.fillRect(e[0]-r/2,e[1]-r/2,r,r),c.strokeRect(e[0]-r/2,e[1]-r/2,r,r),c.restore()},this.drawIconResizeBoxNESW=function(e,r,s){this.drawIconResizeBoxBase(e,r,s),p(t,h.resizeBoxArrowFill,e,s),p(i,h.resizeBoxArrowFill,e,s)},this.drawIconResizeBoxNWSE=function(t,i,s){this.drawIconResizeBoxBase(t,i,s),p(e,h.resizeBoxArrowFill,t,s),p(r,h.resizeBoxArrowFill,t,s)},this.drawCropArea=function(e,t,i,r){var s=e.naturalWidth,a=e.naturalHeight,o=u(e);o&&(s/=2,a/=2);var n=l(e,s,a),g=s/c.canvas.width,p=a/c.canvas.height,v=i.x,_=i.y;c.save(),c.strokeStyle=h.areaOutline,c.lineWidth=2,c.beginPath(),r(c,t,i),c.stroke(),c.clip(),i.w>0&&i.w>0&&c.drawImage(e,v*g*n,_*p*n,i.w*g*n,i.h*p*n,v,_,i.w,i.h),c.beginPath(),r(c,t,i),c.stroke(),c.clip(),c.restore()}}}]),e.factory("cropHost",["$document","cropAreaCircle","cropAreaSquare","cropAreaRectangle",function(e,t,i,r){var s=function(e){var t=e.getBoundingClientRect(),i=document.body,r=document.documentElement,s=window.pageYOffset||r.scrollTop||i.scrollTop,a=window.pageXOffset||r.scrollLeft||i.scrollLeft,o=r.clientTop||i.clientTop||0,n=r.clientLeft||i.clientLeft||0,h=t.top+s-o,c=t.left+a-n;return{top:Math.round(h),left:Math.round(c)}};return function(a,o,n){function h(){if(c.clearRect(0,0,c.canvas.width,c.canvas.height),c.width=c.widht,null!==g){var e=g.naturalWidth,t=g.naturalHeight,i=x(g);i&&(e/=2,t/=2);var r=1024,s=document.createElement("canvas");s.width=s.height=r;for(var a=s.getContext("2d"),o=S(g,e,t),n=Math.ceil(r*c.canvas.width/e),h=Math.ceil(r*c.canvas.height/t/o),l=0,p=0;t>l;){for(var v=0,_=0;e>v;)a.clearRect(0,0,r,r),a.drawImage(g,-v,-l),c.drawImage(s,0,0,r,r,_,p,n,h),v+=r,_+=n;l+=r,p+=h}c.restore(),s=a=null,c.save(),c.fillStyle="rgba(0, 0, 0, 0.65)",c.fillRect(0,0,c.canvas.width,c.canvas.height),c.restore(),u.draw()}}var c=null,g=null,u=null,l=this,p=[100,100],v=[300,300],_=null,z=null,f={w:200,h:200},d=function(){if(null!==g){u.setImage(g);var e=[g.width,g.height],t=g.width/g.height,i=e;i[0]>v[0]?(i[0]=v[0],i[1]=i[0]/t):i[0]<p[0]&&(i[0]=p[0],i[1]=i[0]/t),i[1]>v[1]?(i[1]=v[1],i[0]=i[1]*t):i[1]<p[1]&&(i[1]=p[1],i[0]=i[1]*t),a.prop("width",i[0]).prop("height",i[1]).css({"margin-left":-i[0]/2+"px","margin-top":-i[1]/2+"px"});var r=c.canvas.width,s=c.canvas.height,o=l.getAreaType();"circle"===o||"square"===o?r=s=Math.min(r,s):"rectangle"===o&&null!==u._aspectRatio&&(s=r/u._aspectRatio),u.setSize({w:Math.min(200,r/2),h:Math.min(200,s/2)}),u.setCenterPoint({x:c.canvas.width/2,y:c.canvas.height/2})}else a.prop("width",0).prop("height",0).css({"margin-top":0});h()},m=function(e){if(null!==g){var t,i,r=s(c.canvas);"touchmove"===e.type?(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY):(t=e.pageX,i=e.pageY),u.processMouseMove(t-r.left,i-r.top),h()}},w=function(e){if(e.preventDefault(),e.stopPropagation(),null!==g){var t,i,r=s(c.canvas);"touchstart"===e.type?(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY):(t=e.pageX,i=e.pageY),u.processMouseDown(t-r.left,i-r.top),h()}},y=function(e){if(null!==g){var t,i,r=s(c.canvas);"touchend"===e.type?(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY):(t=e.pageX,i=e.pageY),u.processMouseUp(t-r.left,i-r.top),h()}},x=function(e){var t=e.naturalWidth,i=e.naturalHeight;if(t*i>1048576){var r=document.createElement("canvas");r.width=r.height=1;var s=r.getContext("2d");return s.drawImage(e,-t+1,0),0===s.getImageData(0,0,1,1).data[3]}return!1},S=function(e,t,i){var r=document.createElement("canvas");r.width=1,r.height=i;var s=r.getContext("2d");s.drawImage(e,0,0);for(var a=s.getImageData(0,0,1,i).data,o=0,n=i,h=i;h>o;){var c=a[4*(h-1)+3];0===c?n=h:o=h,h=n+o>>1}var g=h/i;return 0===g?1:g};this.getResultImage=function(){var e,t,i=g.naturalWidth,r=g.naturalHeight,s=x(g);s&&(i/=2,r/=2);var a=this.getResultImageSize(),o=S(g,i,r);if("rectangle"==u.getType()){if(a={h:u.getSize().h,w:u.getSize().w},this.getMaxHeight()&&a.h>this.getMaxHeight()){var n=this.getMaxHeight()/a.h;a.w=a.w*n,a.h=a.h*n}if(this.getMaxWidth()&&a.w>this.getMaxWidth()){var n=this.getMaxWidth()/a.w;a.w=a.w*n,a.h=a.h*n}}t=angular.element("<canvas></canvas>")[0],e=t.getContext("2d"),t.width=a.w,t.height=a.h;var h=u.getCenterPoint(),l={dataURI:null,imageData:null};return null!==g&&(e.drawImage(g,(h.x-u.getSize().w/2)*(i/c.canvas.width)*o,(h.y-u.getSize().h/2)*(r/c.canvas.height)*o,u.getSize().w*(i/c.canvas.width)*o,u.getSize().h*(r/c.canvas.height)*o,0,0,a.w,a.h),l.dataURI=t.toDataURL(),l.imageData=t.getContext("2d").getImageData(0,0,t.width,t.height)),l},this.setNewImageSource=function(e){if(g=null,d(),n.trigger("image-updated"),e){var t=new Image;t.onload=function(){n.trigger("load-done"),g=t,d(),n.trigger("image-updated")},t.onerror=function(){n.trigger("load-error")},n.trigger("load-start"),t.src=e}},this.setMaxDimensions=function(e,t){if(v=[e,t],null!==g){var i=c.canvas.width,r=c.canvas.height,s=[g.width,g.height],o=g.width/g.height,n=s;n[0]>v[0]?(n[0]=v[0],n[1]=n[0]/o):n[0]<p[0]&&(n[0]=p[0],n[1]=n[0]/o),n[1]>v[1]?(n[1]=v[1],n[0]=n[1]*o):n[1]<p[1]&&(n[1]=p[1],n[0]=n[1]*o),a.prop("width",n[0]).prop("height",n[1]).css({"margin-left":-n[0]/2+"px","margin-top":-n[1]/2+"px"});var l=c.canvas.width/i,_=c.canvas.height/r,z=Math.min(l,_);u.setSize({w:u.getSize().w*z,h:u.getSize().h*z});var f=u.getCenterPoint();u.setCenterPoint({x:f.x*l,y:f.y*_})}else a.prop("width",0).prop("height",0).css({"margin-top":0});h()},this.setAspectRatio=function(e){angular.isUndefined(e)||(e=parseFloat(e),isNaN(e)||(u.setAspectRatio(e),h()))},this.setAreaMinSize=function(e){angular.isUndefined(e)||(e={w:parseInt(e.w,10),h:parseInt(e.h,10)},isNaN(e.w)||isNaN(e.h)||(u.setMinSize(e),h()))},this.getResultImageSize=function(){return"selection"==f?u.getSize():f},this.setResultImageSize=function(e){if(!angular.isUndefined(e)){if(angular.isString(e)&&isNaN(parseFloat(e)))return f=e,void 0;var t=parseInt(e,10);e=isNaN(t)?{w:parseInt(e.w,10),h:parseInt(e.h,10)}:{w:t,h:t},isNaN(e.w)||isNaN(e.h)||(f=e,h())}},this.getAreaType=function(){return u.getType()},this.setAreaType=function(e){var s=u.getCenterPoint(),a=u.getSize(),o=u.getMinSize(),l=s.x,p=s.y,v=t;"square"===e?v=i:"rectangle"===e&&(v=r),u=new v(c,n),u.setMinSize(o),u.setSize(a),u.setCenterPoint({x:l,y:p}),null!==g&&u.setImage(g),h()},this.setMaxHeight=function(e){return _=e},this.getMaxHeight=function(){return _},this.setMaxWidth=function(e){return z=e},this.getMaxWidth=function(){return z},c=a[0].getContext("2d"),u=new t(c,n),e.on("mousemove",m),a.on("mousedown",w),e.on("mouseup",y),e.on("touchmove",m),a.on("touchstart",w),e.on("touchend",y),this.destroy=function(){e.off("mousemove",m),a.off("mousedown",w),e.off("mouseup",m),e.off("touchmove",m),a.off("touchstart",w),e.off("touchend",m),a.remove()}}}]),e.factory("cropPubSub",[function(){return function(){var e={};this.on=function(t,i){return t.split(" ").forEach(function(t){e[t]||(e[t]=[]),e[t].push(i)}),this},this.trigger=function(t,i){return angular.forEach(e[t],function(e){e.call(null,i)}),this}}}]),e.directive("imgCrop",["$timeout","cropHost","cropPubSub",function(e,t,i){return{restrict:"E",scope:{image:"=",resultImage:"=",resultImageData:"=",changeOnFly:"=",areaType:"@",aspectRatio:"=",areaMinSize:"=",resultImageSize:"@",maxHeight:"@",maxWidth:"@",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"},template:"<canvas></canvas>",controller:["$scope",function(e){e.events=new i}],link:function(i,r){var s,a=i.events,o=new t(r.find("canvas"),{},a),n=function(e){var t=o.getResultImage(),i=t.dataURI;s!==i&&(s=i,angular.isDefined(e.resultImage)&&(e.resultImage=i),angular.isDefined(e.resultImageData)&&(e.resultImageData=t.imageData),e.onChange({$dataURI:e.resultImage}),e.onChange({$imageData:e.resultImageData}))},h=function(t){return function(){e(function(){i.$apply(function(e){t(e)})})}};a.on("load-start",h(function(e){e.onLoadBegin({})})).on("load-done",h(function(e){e.onLoadDone({})})).on("load-error",h(function(e){e.onLoadError({})})).on("area-move area-resize",h(function(e){e.changeOnFly&&n(e)})).on("area-move-end area-resize-end image-updated",h(function(e){n(e)})),i.$watch("image",function(){o.setNewImageSource(i.image)}),i.$watch("areaType",function(){o.setAreaType(i.areaType),n(i)}),i.$watch("aspectRatio",function(){o.setAspectRatio(i.aspectRatio),n(i)}),i.$watch("areaMinSize",function(){o.setAreaMinSize(i.areaMinSize),n(i)}),i.$watch("resultImageSize",function(){o.setResultImageSize(i.resultImageSize),n(i)}),i.$watch("maxHeight",function(){o.setMaxHeight(i.maxHeight),n(i)}),i.$watch("maxWidth",function(){o.setMaxWidth(i.maxWidth),n(i)}),i.$watch(function(){return[r[0].clientWidth,r[0].clientHeight]},function(e){o.setMaxDimensions(e[0],e[1]),n(i)},!0),i.$on("$destroy",function(){o.destroy()})}}}])}();